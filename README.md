# ADPass2SMS

**ADPass2SMS** — это PowerShell‑решение для автоматической ротации паролей учетных записей Active Directory с доставкой новых паролей пользователям через SMS‑шлюз [SMS.ru](https://sms.ru).

---

## 🚀 Возможности

- Получение списка пользователей из **Active Directory** с поддержкой фильтрации:
  - OU (Organizational Unit)
  - Только активные учетные записи
  - Проверка наличия мобильного номера
  - Членство в определенной группе (опционально)
- Генерация новых паролей:
  - Основаны на **произносимых слогах** (удобнее воспринимаются людьми)
  - Поддержка **двухбуквенных и трёхбуквенных слогов**
  - Настраиваемые спецсимволы
  - Числовой суффикс фиксированной длины
  - Опциональная **«соль»** — пароль в SMS отличается от реального, но восстанавливается простым правилом `(pX)` / `(mX)`
- Интеграция с SMS.ru API:
  - Проверка авторизации и баланса
  - Отправка сообщений
  - Обработка ошибок (например, неподключённый оператор)
- Гибкое логирование:
  - Текстовый лог + CSV‑отчёт
  - Разделение каналов логирования (**Main** / **Sms**)
  - Пароли скрываются в логах (`***`), но при отладке могут выводиться полностью
- Поддержка конфигурации через **psd1‑файл**
- Возможность запуска по расписанию через **Task Scheduler**

---

## ⚙️ Установка

1. Клонировать репозиторий или скопировать проект в рабочую директорию, например:

   ```powershell
   C:\Dev\ADPass2SMS
   ```

2. В папке `Modules` находятся модули:
   - `PasswordGenerator.psm1` — генерация паролей
   - `ADUsers.psm1` — работа с Active Directory
   - `SmsRu.psm1` — взаимодействие с SMS.ru API
   - `Logger.psm1` — централизованное логирование

3. Настроить файл `config.psd1`:
   - API‑ключ SMS.ru (`api_id`)
   - Параметры фильтра AD (OU, фильтр LDAP, группа)
   - Политика генерации паролей
   - Режимы отладки

4. Запустить основной скрипт:

   ```powershell
   .\ADPass2SMS.ps1
   ```

---

## 📝 Пример работы с солью

- В AD сохраняется пароль:  
  **`HekaCagoD53*`**  

- В SMS уходит:  
  **`HekaCagoD47* (p6)`**  

- Пользователь прибавляет `6` к числу `47` → получает реальный пароль `53`.  

Аналогично `(mX)` означает вычесть `X`.

---

## 📅 Автоматизация

Рекомендуется запускать через **Task Scheduler** от имени сервисной учётной записи:

```powershell
$action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument '-ExecutionPolicy Bypass -File "C:\Dev\ADPass2SMS\ADPass2SMS.ps1"'
$trigger = New-ScheduledTaskTrigger -Weekly -DaysOfWeek Monday -At 3am

Register-ScheduledTask `
    -TaskName "ADPass2SMS" `
    -Action $action `
    -Trigger $trigger `
    -User "svc_adpass2sms@zim-service.ru" `
    -Password "SuperStrongPassw0rd!1!"
```

---

## 🔐 Безопасность

- Пароли никогда не пишутся в текстовые логи (заменяются на `***`).
- Отладочный вывод можно включать выборочно (для Main или SMS).
- Пароль пользователя в SMS можно маскировать с помощью механизма соли.

---

## 👨‍💻 Авторы

Разработано как proof‑of‑concept для безопасной ротации паролей AD.  
